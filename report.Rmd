---
title: "Analyses: Classclimate 2020"
author: "JÃ¼rgen Wilbert"
date: "Version (`r Sys.Date()`)"

output:
  html_document:
    theme: default
    df_print: paged
    toc: TRUE
    toc_depth: 2
    toc_float:
      collapsed: false
bibliography: packages.bib
geometry: a4paper
link-citations: yes
biblio-style: apalike
---

```{r setup, include=FALSE}
# load packages -----------------------------------------------------------

if (!("wmisc" %in% installed.packages())) 
  devtools::install_github("jazznbass/wmisc")
if (!("scaledic" %in% installed.packages())) 
  devtools::install_github("jazznbass/scaledic")

packages <- c('sjPlot', 'knitr', 'semTable', 'kableExtra', 'bookdown', 
              'scaledic', 'Amelia', 'wmisc', 'psych', 'lavaan', 'nlme', 'lme4',
              'tidyverse', 'readxl', 'gridExtra', 'broom')

invisible(sapply(packages, library, character.only = TRUE))

# load data

dat <- readRDS("data.rds")


.var <- c(
  "feess_kk", "feess_si", "LM_in", "LL_in","Friend_in", "sar_victim", 
  "sar_perpetrator", "itrf_int", "itrf_ext", "itrf_sw", "itrf_ad", "itrf_apd", 
  "itrf_opp", "itrf_int", "itrf_ext", "soc_relatedness", "soc_positivity", "n_valid_like"
)
.var <- paste0(.var, rep(c("_mean", "_sd"), each = length(.var)))

dat_agg <- dat %>% group_by(id_class_teacher) %>%
  summarise(across(!!.var, mean))

# set parameters

knitr::opts_chunk$set(echo = TRUE)

# function for nicer output
html_table <- function(table, title = "", footnote = "") {
  
  title <- paste0("Table.<br><i>", title, "</i>")
  kable(table, caption = title) %>%
   kable_classic() %>%
   footnote(footnote)
}
```

# Software acknowledgment

The following packages were used for this report:

`R` at version `r R.version$version.string` [@R-base].

```{r package_reference, results="asis", echo=FALSE}
wmisc::reference_package_version(packages)
```

------------------------------------------------------------------------

# Descriptives

```{r descriptives_l1}
.var <- c(
  "feess_kk", "feess_si", "soc_relatedness", "soc_positivity", "LM_in", "LL_in","Friend_in", "sar_victim", 
  "sar_perpetrator", "itrf_int", "itrf_ext", "itrf_sw", "itrf_ad", "itrf_apd", "itrf_opp", "itrf_int", "itrf_ext", "age"
)

# correct wrong class in age (is: time; should be: numeric)
class(dat$age) <- c("dic", "numeric")

dat %>% select(!!.var) %>% descriptives() %>% html_table

dat %>% group_by(grade) %>% summarise(n = n()) %>% html_table
dat %>% group_by(sex) %>% summarise(n = n()) %>% html_table
dat %>% group_by(migration_background) %>% summarise(n = n()) %>% html_table

dat %>% select(!!.var) %>% wmisc::nice_corrmatrix(lower = FALSE) %>% html_table
```

```{r descriptives_l2}
descriptives(dat_agg[-1]) %>% html_table
dat_agg %>% 
  select(ends_with("_mean")) %>%
  wmisc::nice_corrmatrix(lower = FALSE) %>% html_table
```

# Exploring the problems with sociometric data

```{r}
dat %>% group_by(grade) %>%
  summarise(
    across(c("LL_in", "LM_in", "Friend_in", "soc_relatedness", "soc_positivity"), list(mean = ~mean(.x, na.rm = TRUE))),
  n = n()) %>% round(2) %>%
  html_table()


```


# Exploratory factor analyses

```{r efa_l1}
var <- c("feess_kk", "feess_si", "soc_relatedness", "soc_positivity", "Friend_in", "sar_victim", "sar_perpetrator")

dat %>% select(!!var) %>% fa.parallel()

dat %>% select(!!var) %>% exploratory_fa(nfactors = 4) %>% html_table()

```



```{r efa_l2}
var <- c("feess_kk", "feess_si", "soc_relatedness", "soc_positivity","Friend_in", "sar_victim", "sar_perpetrator")
var <- paste0(var, "_mean")

dat_agg %>% select(!!var) %>% fa.parallel()

dat_agg %>% select(!!var) %>% exploratory_fa(nfactors = 3, fm = "ml") %>% html_table()

```

```{r efa_l2_zmp}
var <- c("feess_kk", "feess_si", "LM_in","Friend_in", "sar_victim", "sar_perpetrator")
var <- paste0(var, "_mean")
#dat_agg %>% select(!!var) %>% fa.parallel()
dat_agg %>% select(!!var) %>% exploratory_fa(nfactors = 3, fm = "ml") %>% html_table()

```


# Reference
