---
title: "Analyses: Entangling social-emotional classclimate and its relation to students behavioral problems"
author: "J체rgen Wilbert"
date: "Version (`r Sys.Date()`)"
output:
  html_document:
    theme: cosmo
    df_print: paged
    toc: TRUE
    toc_depth: 2
    toc_float:
      collapsed: false
  prettydoc::html_pretty:
    theme: architect
    highlight: github
bibliography: packages.bib
geometry: a4paper
link-citations: yes
biblio-style: apalike
---

```{r setup, include=FALSE}
# load packages -----------------------------------------------------------

if (!("wmisc" %in% installed.packages())) 
  devtools::install_github("jazznbass/wmisc")
if (!("scaledic" %in% installed.packages())) 
  devtools::install_github("jazznbass/scaledic")

packages <- c(
  'sjPlot', 'knitr', 'semTable', 'kableExtra', 'bookdown', 
  'scaledic', 'Amelia', 'wmisc', 'psych', 'lavaan', 'nlme', 'lme4',
  'tidyverse', 'readxl', 'gridExtra', 'broom', 'sjPlot', 'mclust'
)

invisible(sapply(packages, library, character.only = TRUE))

# load data

dat <- readRDS("data.rds")

.var <- c(
  "feess_kk", "feess_si", "LM_in", "LL_in","Friend_in", "sar_victim", 
  "sar_perpetrator", "itrf_int", "itrf_ext", "itrf_sw", "itrf_ad", "itrf_apd", 
  "itrf_opp", "itrf_int", "itrf_ext", "soc_relatedness", "soc_positivity", "n_valid_like", "density_ll", "density_lm", "density_friend", "density_impact"
)
.var <- paste0(.var, rep(c("_mean", "_sd"), each = length(.var)))

dat_agg <- dat %>% group_by(id_class_teacher) %>%
  summarise(across(!!.var, mean))

# Define variables: classclimate/wellbeing/behavioral problems/control for all analyzes
var_cc_l1 <- c("feess_si", "LM_in","Friend_in", "sar_victim", "sar_perpetrator")
var_cc_l2 <- paste0(var_cc_l1, "_mean")
var_cc_l2_sd <- paste0(var_cc_l1, "_sd")

var_bp_l1 <- c("itrf_sw", "itrf_ad", "itrf_apd", "itrf_opp")
var_bp_l2 <- paste0(var_bp_l1, "_mean")
var_bp_l2_sd <- paste0(var_bp_l1, "_sd")

var_cont_l1 <- c("age", "grade", "sex", "migration_background")
var_cont_l2 <- paste0(var_cont_l1, "_mean")
var_cont_l2_sd <- paste0(var_cont_l1, "_sd")

# set parameters

knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

# function for nicer output
html_table <- function(table, title = "", footnote = "") {
  title <- paste0("Table.<br><i>", title, "</i>")
  kable(table, caption = title) %>%
   kable_classic(full_width = FALSE) %>%
   footnote(footnote)
}

html_regression <- function(fit, ...) {
  sjPlot::tab_model(fit, show.std = TRUE, show.se = TRUE, show.ci = FALSE, ...)
}

```

# Software acknowledgment

The following packages were used for this report:

`R` at version `r R.version$version.string` [@R-base].

```{r package_reference, results="asis", echo=FALSE}
wmisc::reference_package_version(packages)
```

------------------------------------------------------------------------

# Research questions

Frage 1a: Lassen sich die von uns aufgestellten Komponenten des social wellbeings in einem Konstrukt abbilden.

Frage 1b: Lassen sich die von uns aufgestellten Komponenten des aggregierten social-wellbeings in einem Konstrukt social-emotional class climate abbilden.

Frage 2: Wie stark lassen sich Unterschiede in Verhaltensproblemen (in 4 Dimensionen unterteilt) durch das social-emotional wellbing + das social-emotional classclimate erkl채ren.

# Descriptives of all variables

```{r descriptives_l1}
.var <- c(var_cc_l1, var_bp_l1, "age")

# correct wrong class in age (is: time; should be: numeric)
class(dat$age) <- c("dic", "numeric")

dat %>% select(!!.var) %>% descriptives() %>% html_table

dat %>% group_by(grade) %>% summarise(n = n()) %>% html_table
dat %>% group_by(sex) %>% summarise(n = n()) %>% html_table
dat %>% group_by(migration_background) %>% summarise(n = n()) %>% html_table

dat %>% select(!!.var) %>% wmisc::nice_corrmatrix(upper = FALSE, numbered_columns = TRUE, char_p10 = "T") %>% html_table
```

```{r descriptives_l2}
.var <- c(var_cc_l2, var_bp_l2)
descriptives(dat_agg[.var]) %>% html_table
dat_agg %>% 
  select(!!.var) %>%
  wmisc::nice_corrmatrix(upper = FALSE, numbered_columns = TRUE, char_p10 = "T") %>% html_table
```

# Research question 1: Lassen sich die von uns aufgestellten Komponenten des social wellbeings in einem Konstrukt abbilden.

# Social wellbeing (individual level)

We conducted a parallel analysis to determine the number of factors to be extracted from the data. The analysis point to three factors (see figure xxx)

```{r parallel_l1, fig.cap="Parallel analysis scree plot."}
dat %>% select(!!var_cc_l1) %>% fa.parallel(main = "", fa = "fa")
```

While an empirical BIC as well as a Sample Size adjusted BIC achieve a minimum with 2 factors.

```{r nfactor_l1}
res <- dat %>% select(!!var_cc_l1) %>% nfactors(n = 5)
```

```{r efa_l1}

dat %>% select(!!var_cc_l1) %>% exploratory_fa(nfactors = 3, fm = "minres") %>% html_table("Exploratory factor analyzes of wellbeing variables.")

```

# Research question 1b\_: Lassen sich die von uns aufgestellten Komponenten des aggregierten social-wellbeings in einem Konstrukt social-emotional class climate abbilden.

# Class climate (class level)

We conducted a parallel analysis to determine the number of factors to be extracted from the data. The analysis point to two factors (see figure xxx).

```{r nfactors_l2, , fig.cap="Parallel analysis scree plot."}
dat_agg %>% select(!!var_cc_l2) %>% fa.parallel(main = "", fa = "fa")
```

```{r}
dat_agg %>% select(!!var_cc_l2) %>% nfactors(n = 6)
```

```{r efa_l2}
dat_agg %>% 
  select(!!var_cc_l2) %>% exploratory_fa(nfactors = 3, fm = "ml") %>%
  html_table("Exploratory factor analyzes of classclimate variables.")
```

# Reseach question 2: Wie stark lassen sich Unterschiede in Verhaltensproblemen (in 4 Dimensionen unterteilt) durch das social-emotional wellbing + das social-emotional classclimate erkl채ren.

```{r}
fit <- lme(itrf_sw ~ feess_si + LM_in + Friend_in + sar_victim + sar_perpetrator, random =~ 1 | id_class_teacher, data = dat, na.action = na.omit)
html_regression(fit, title = "Social withdrawal regressed on wellbing variables")
```

```{r}
fit <- lme(itrf_ad ~ feess_si + LM_in + Friend_in + sar_victim + sar_perpetrator, random =~ 1 | id_class_teacher, data = dat, na.action = na.omit)
html_regression(fit, title = "Anxiety/depression regressed on wellbing variables")
```

```{r}
fit <- lme(itrf_apd ~ feess_si + LM_in + Friend_in + sar_victim + sar_perpetrator, random =~ 1 | id_class_teacher, data = dat, na.action = na.omit)
html_regression(fit, title = "Academic disorganized behavior regressed on wellbing variables")
```

```{r}
fit <- lme(itrf_opp ~ feess_si + LM_in + Friend_in + sar_victim + sar_perpetrator, random =~ 1 | id_class_teacher, data = dat, na.action = na.omit)
html_regression(fit, title = "Opositional behavior regressed on wellbing variables")
```

# Reseach question 2b: Wie stark lassen sich Unterschiede in Verhaltensproblemen in einer Klasse (in 4 Dimensionen unterteilt) durch das classenclima erkl채ren.

```{r}
fit <- lm(itrf_sw_mean ~ feess_si_mean + LM_in_mean + Friend_in_mean + sar_victim_mean + sar_perpetrator_mean, data = dat_agg, na.action = na.omit)
html_regression(fit, title = "Social withdrawal regressed on classclimate")
```

```{r}
fit <- lm(itrf_ad_mean ~ feess_si_mean + LM_in_mean + Friend_in_mean + sar_victim_mean + sar_perpetrator_mean, data = dat_agg, na.action = na.omit)
html_regression(fit, title = "Anxiety/depression regressed on classclimate")
```

```{r}
fit <- lm(itrf_apd_mean ~ feess_si_mean + LM_in_mean + Friend_in_mean + sar_victim_mean + sar_perpetrator_mean, data = dat_agg, na.action = na.omit)
html_regression(fit, title = "Academic disorganized behavior regressed on classclimate")
```

```{r}
fit <- lm(itrf_opp_mean ~ feess_si_mean + LM_in_mean + Friend_in_mean + sar_victim_mean + sar_perpetrator_mean, data = dat_agg, na.action = na.omit)
html_regression(fit, title = "Opositional behavior regressed on wellbing variables")
```

# Reseach question 3: Explaining indidual behavioral problems by means of classclimate

```{r}
fit <- lme(itrf_sw ~ feess_si + LM_in + Friend_in + sar_victim + sar_perpetrator + feess_si_mean + LM_in_mean + Friend_in_mean + sar_victim_mean + sar_perpetrator_mean, random =~ 1 | id_class_teacher, data = dat, na.action = na.omit)
html_regression(fit, title = "Social withdrawal regressed on wellbing and classclimate variables")
```

```{r}
fit <- lme(itrf_ad ~ feess_si + LM_in + Friend_in + sar_victim + sar_perpetrator + feess_si_mean + LM_in_mean + Friend_in_mean + sar_victim_mean + sar_perpetrator_mean, random =~ 1 | id_class_teacher, data = dat, na.action = na.omit)
html_regression(fit, title = "Anxiety/Depression regressed on wellbing and classclimate variables")
```

```{r}
fit <- lme(itrf_apd ~ feess_si + LM_in + Friend_in + sar_victim + sar_perpetrator + feess_si_mean + LM_in_mean + Friend_in_mean + sar_victim_mean + sar_perpetrator_mean, random =~ 1 | id_class_teacher, data = dat, na.action = na.omit)
html_regression(fit, title = "Academic disengagement regressed on wellbing and classclimate variables")
```

```{r}
fit <- lme(itrf_opp ~ feess_si + LM_in + Friend_in + sar_victim + sar_perpetrator + feess_si_mean + LM_in_mean + Friend_in_mean + sar_victim_mean + sar_perpetrator_mean, random =~ 1 | id_class_teacher, data = dat, na.action = na.omit)
html_regression(fit, title = "Oppositional behavior regressed on wellbing and classclimate variables")
```

# Explorative: Latent profile annalyses

Are there patterns of

a.  Wellbeing?
b.  Classclimate?

## Profiles of wellbeeing

```{r}
dat2 <- dat %>%
  select(!!var_cc_l1) %>%
  na.omit() %>%
  mutate(across(everything(), scale))

# fit_bic <- mclustBIC(dat2)
# saveRDS(fit_bic, "fit_bic.rds")
fit_bic <- readRDS("fit_bic.rds")

#plot(fit_bic)
#summary(fit_bic)

# fit_icl <- mclustICL(dat2)
# saveRDS(fit_icl, "fit_icl.rds")
fit_icl <- readRDS("fit_icl.rds")

#plot(fit_icl)
#summary(fit_icl)

# bootstrap <- mclustBootstrapLRT(dat2, modelName = "VEV", maxG = 9)
# saveRDS(bootstrap, "bootstrap.rds")
bootstrap <- readRDS("bootstrap.rds")
```



```{r}
mod1 <- Mclust(dat2, modelNames = "VEV", G = 3, x = fit_bic)
#summary(mod1)

means <- as.data.frame(mod1$parameters$mean) %>%
  rownames_to_column("Variable") %>%
  pivot_longer(cols = -1) %>%
  mutate(name = recode(name,
    V1 = "Involved in bullying 39%",
    V2 = "Low social inclusion 8%",
    V3 = "High social inclusion 53%"
  ))

p <- means %>%
  ggplot(aes(Variable, value, group = name, color = name)) +
  geom_point(size = 2.25) +
  geom_line(size = 1.25) +
  theme_bw(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p

mod1 <- Mclust(dat2, modelNames = "VEV", G = 4, x = fit_bic)
#summary(mod1)

means <- as.data.frame(mod1$parameters$mean) %>%
  rownames_to_column("Variable") %>%
  pivot_longer(cols = -1) %>%
   mutate(name = recode(name,
    V1 = "Lower inclusion, bullying 19%",
    V2 = "Low inclusion, no bullying 18%",
    V3 = "Bully and Bullied 20%",
    V4 = "High inclusion, no bullying 44%"
  ))

p <- means %>%
  ggplot(aes(Variable, value, group = name, color = name)) +
  geom_point(size = 2.25) +
  geom_line(size = 1.25) +
  theme_bw(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p

mod1 <- Mclust(dat2, modelNames = "VEV", G = 5, x = fit_bic)
#summary(mod1)

means <- as.data.frame(mod1$parameters$mean) %>%
  rownames_to_column("Variable") %>%
  pivot_longer(cols = -1) %>%
   mutate(name = recode(name,
    V1 = "Lower inclusion, bully 11%",
    V2 = "Low inclusion, bully and bullied 17%",
    V3 = "Bully and Bullied 11%",
    V4 = "Feels included, no bullying 32%",
    V5 = "Feels less included, no bulying 31%"
    
  ))

p <- means %>%
  ggplot(aes(Variable, value, group = name, color = name)) +
  geom_point(size = 2.25) +
  geom_line(size = 1.25) +
  theme_bw(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p

```



## Profiles of classclimate

```{r}
dat2 <- dat_agg %>%
  select(!!var_cc_l2) %>%
  na.omit() %>%
  mutate(across(everything(), scale))

# fit_bic <- mclustBIC(dat2)
# saveRDS(fit_bic, "fit_bic_l2.rds")
fit_bic <- readRDS("fit_bic_l2.rds")

#plot(fit_bic)
#summary(fit_bic)

#fit_icl <- mclustICL(dat2)
#saveRDS(fit_icl, "fit_icl_l2.rds")
fit_icl <- readRDS("fit_icl_l2.rds")

#plot(fit_icl)
#summary(fit_icl)

#bootstrap <- mclustBootstrapLRT(dat2, modelName = "EVE", maxG = 3)
#saveRDS(bootstrap, "bootstrap_l2.rds")
bootstrap <- readRDS("bootstrap_l2.rds")
```



```{r}
mod1 <- Mclust(dat2, modelNames = "EVE", G = 2, x = fit_bic)
#summary(mod1)

means <- as.data.frame(mod1$parameters$mean) %>%
  rownames_to_column("Variable") %>%
  pivot_longer(cols = -1) %>%
  mutate(name = recode(name,
    V1 = "Average inc., lower bullying 87%",
    V2 = "Lower feeling of inc., high bullying 13%"
  ))

p <- means %>%
  ggplot(aes(Variable, value, group = name, color = name)) +
  geom_point(size = 2.25) +
  geom_line(size = 1.25) +
  theme_bw(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p

```

## Profile and behavioral problems

### Social-emotional wellbeeing

```{r}
dat2 <- dat %>%
  select(!!var_cc_l1) %>%
  na.omit() %>%
  mutate(across(everything(), scale))

fit_bic <- readRDS("fit_bic.rds")

mod1 <- Mclust(dat2, modelNames = "VEV", G = 5, x = fit_bic)

dat2 <- dat
dat2$filter <- apply(dat2[,var_cc_l1], 1, function(x) any(is.na(x)))
dat2 <- dat2 %>% filter(!filter)
dat2$profile <- factor(mod1$classification, labels = c(
  "Inc (-) bully (+) 11%",
  "Inc (-) bully/bullied (+) 17%",
  "Bully/Bullied (+) 11%",
  "Feel inc. (+) bullying (-) 32%",
  "Feel inc. (-) bulying (-) 31%"))

dat2 <- dat2 %>% mutate(across(!!c(var_bp_l1, var_cc_l1), scale))

dat2 %>% group_by(profile) %>% 
  summarise(across(!!var_bp_l1, mean, na.rm = TRUE)) %>%
  pivot_longer(col = -1) %>%
  ggplot(aes(x = profile, y = value, fill = name)) +
  geom_bar(stat = "identity",position = "dodge" ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


   

```


### Classclimate

```{r}
dat2 <- dat_agg %>%
  select(!!var_cc_l2) %>%
  na.omit() %>%
  mutate(across(everything(), scale))

fit_bic <- readRDS("fit_bic_l2.rds")

mod1 <- Mclust(dat2, modelNames = "EVE", G = 2, x = fit_bic)

dat2 <- dat_agg
dat2$filter <- apply(dat2[,var_cc_l2], 1, function(x) any(is.na(x)))

dat2 <- dat2 %>% filter(!filter)
dat2$profile <- factor(mod1$classification, labels = c("Incl. (0), bullying (-) 87%","Feel. inc. (-), bullying (+) 13%"))

dat2 <- dat2 %>% mutate(across(!!c(var_bp_l2, var_cc_l2), scale))

dat2 %>% group_by(profile) %>% 
  summarise(across(!!var_bp_l2, mean, na.rm = TRUE)) %>%
  pivot_longer(col = -1) %>%
  ggplot(aes(x = profile, y = value, fill = name)) +
  geom_bar(stat = "identity",position = "dodge" )
```


# Reference
